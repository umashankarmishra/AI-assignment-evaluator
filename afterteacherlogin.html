<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="teacher.css">
</head>

<body>

<div class="topbar">
    <div class="logo">
        <span>ğŸ‘©â€ğŸ«</span>
        <span>Teacher Dashboard</span>
    </div>
    <div class="top-actions">
        <button class="btn-theme" onclick="toggleTheme()">ğŸŒ™ Theme</button>
        <button class="btn-logout" onclick="logout()">Logout</button>
    </div>
</div>

<div class="container">
    <h2>ğŸ“Š Class Summary</h2>
    <div class="summary-stats">
        <div class="stat-pill">
            <label>Total Students</label>
            <div class="stat-value" id="totalStudents">â€”</div>
        </div>
        <div class="stat-pill">
            <label>Average Score</label>
            <div class="stat-value" id="classAverage">â€”</div>
        </div>
    </div>
</div>

<div class="container">
    <h2>ğŸ“˜ Attendance & Submissions</h2>
    <div class="form-row">
        <input type="text" id="newStudentName" placeholder="Enter student nameâ€¦">
        <button id="addStudentBtn" class="btn-primary-glow" onclick="addStudent()">â• Add Student</button>
        <button id="saveBtn" class="btn-primary-glow" onclick="saveAttendance()">ğŸ’¾ Save All</button>
    </div>
    <table id="attendanceTable">
        <thead>
            <tr>
                <th>Name</th>
                <th>Present Today</th>
                <th>Attendance %</th>
                <th>Assignment Submitted</th>
                <th>Remove</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div class="container">
    <h2>ğŸ“¤ Upload Master Questions</h2>
    <p class="upload-hint">Upload a PDF question paper for students to view.</p>
    <div class="upload-stack">
        <input type="file" id="questionFile" accept="application/pdf">
        <button id="uploadQBtn" onclick="uploadQuestions()">ğŸ“¬ Post Questions to Students</button>
    </div>
    <p id="uploadStatus"></p>
</div>

<div class="container">
    <h2>ğŸ¤– AI Evaluated Results</h2>
    <p class="upload-hint">View detailed AI feedback and graded answer sheets.</p>
    <div id="evaluatedList" class="assignment-grid"></div>
</div>

<div class="container">
    <h2>ğŸ“ All Submissions</h2>
    <div id="classList" class="assignment-grid"></div>
    <hr class="leaderboard-divider">
    <h3>ğŸ† Top Performers</h3>
    <div id="leaderboard"></div>
</div>

<script>
    
    const supabaseUrl = "https://dezrvgfkzwdpdzztbiyo.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRlenJ2Z2ZrendkcGR6enRiaXlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNTQ0MDEsImV4cCI6MjA4NjczMDQwMX0.yspqyhyhG4k3V47vGi29eemNN-BPLhefrBfzvy82JLo";
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    let students = [];

    
    async function loadAttendance() {
        const { data, error } = await supabaseClient.from("attendance").select("*");
        if (error || !data) return;

        const uniqueNames = [...new Set(data.map(s => s.student_name))];
        students = uniqueNames.map(name => {
            const records = data.filter(s => s.student_name === name);
            const total = records.length;
            const present = records.filter(s => s.present).length;
            const percentage = total > 0 ? ((present / total) * 100).toFixed(1) : "0.0";
            const submitted = localStorage.getItem("submit_" + name) || null;
            return { name, presentToday: false, percentage, submitted };
        });
        renderAttendance();
    }

    function renderAttendance() {
        const tbody = document.querySelector("#attendanceTable tbody");
        tbody.innerHTML = "";
        students.forEach((student, i) => {
            const yesClass = student.submitted === "yes" ? "active-yes" : "";
            const noClass = student.submitted === "no" ? "active-no" : "";
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${student.name}</td>
                <td style="text-align:center;"><input type="checkbox" onchange="togglePresent(${i})"></td>
                <td>${student.percentage}%</td>
                <td>
                    <div class="submit-toggle">
                        <button class="${yesClass}" onclick="setSubmission(${i},'yes')">âœ“ Yes</button>
                        <button class="${noClass}" onclick="setSubmission(${i},'no')">âœ— No</button>
                    </div>
                </td>
                <td><button class="btn-remove" onclick="removeStudent(${i})">âœ•</button></td>
            `;
            tbody.appendChild(row);
        });
    }
async function loadDashboard() {
    const { data: submissions, error } = await supabaseClient
        .from("assignments")
        .select("*")
        .order("submission_date", { ascending: false });

    const container = document.getElementById("classList");
    const evaluatedContainer = document.getElementById("evaluatedList");

    container.innerHTML = "";
    evaluatedContainer.innerHTML = "";

    if (error || !submissions || submissions.length === 0) {
        container.innerHTML = `<p>No submissions found.</p>`;
        evaluatedContainer.innerHTML = `<p>No evaluations found.</p>`;
        return;
    }

    submissions.forEach(sub => {

        const box = document.createElement("div");
        box.className = "assignment-box";

        box.innerHTML = `
            <strong>ğŸ‘¤ ${sub.student_name}</strong>
            <p>${sub.subject || 'Math'} â€” ${sub.title}</p>
            <p>Status: ${sub.status || "Pending"}</p>
            <p>Marks: ${sub.total_marks ?? "Not graded"}</p>
            <button onclick="window.open('${sub.file_url}','_blank')">
                ğŸ“„ View Submission
            </button>
        `;

        container.appendChild(box);

       
        if (sub.total_marks !== null) {

            const aiBox = document.createElement("div");
            aiBox.className = "assignment-box ai-highlight";

            aiBox.innerHTML = `
                <div style="display:flex; justify-content:space-between;">
                    <strong>ğŸ“ ${sub.student_name}</strong>
                    <span class="score-pill">${sub.total_marks}/100</span>
                </div>
                <p>${sub.title}</p>
                <p style="font-style:italic;">
                    "${sub.ai_remark || 'No feedback'}"
                </p>
                <button class="btn-ai-pdf"
                    onclick="window.open('${sub.file_url}','_blank')">
                    ğŸ¤– View Graded PDF
                </button>
            `;

            evaluatedContainer.appendChild(aiBox);
        }
    });
}
   
    

    
    function togglePresent(index) { students[index].presentToday = !students[index].presentToday; }
    function setSubmission(index, value) {
        students[index].submitted = value;
        localStorage.setItem("submit_" + students[index].name, value);
        renderAttendance();
    }
    function addStudent() {
        const name = document.getElementById("newStudentName").value.trim();
        if (!name) return;
        students.push({ name, presentToday: false, percentage: "0.0", submitted: null });
        document.getElementById("newStudentName").value = "";
        renderAttendance();
    }
    function removeStudent(index) {
        students.splice(index, 1);
        renderAttendance();
    }

    async function saveAttendance() {
        const today = new Date().toISOString().split("T")[0];
        for (const s of students) {
            await supabaseClient.from("attendance").upsert([{ student_name: s.name, date: today, present: s.presentToday }]);
        }
        alert("Saved!");
        loadAttendance();
    }

    async function loadClassSummary() {
        const { data } = await supabaseClient.from("assignments").select("student_name, total_marks");
        if (!data) return;
        const unique = [...new Set(data.map(s => s.student_name))];
        document.getElementById("totalStudents").textContent = unique.length;
        const graded = data.filter(s => s.total_marks !== null);
        if (graded.length > 0) {
            const avg = graded.reduce((a, b) => a + b.total_marks, 0) / graded.length;
            document.getElementById("classAverage").textContent = avg.toFixed(1) + " / 100";
        }
    }

    async function loadLeaderboard() {
        const { data } = await supabaseClient.from("assignments").select("student_name, total_marks");
        if (!data) return;
        const ranked = data.filter(s => s.total_marks !== null)
            .sort((a, b) => b.total_marks - a.total_marks).slice(0, 3);
        const medals = ["ğŸ¥‡", "ğŸ¥ˆ", "ğŸ¥‰"];
        document.getElementById("leaderboard").innerHTML = ranked.map((s, i) => `
            <div class="leaderboard-item"><span>${medals[i]} ${s.student_name}</span> <strong>${s.total_marks}</strong></div>
        `).join("");
    }

    async function uploadQuestions() {
        const file = document.getElementById("questionFile").files[0];
        if (!file) {
            alert("Please select a PDF file first.");
            return;
        }

        const status = document.getElementById("uploadStatus");

        status.className = "uploading";
        status.innerHTML = "â³ Uploading <strong>" + file.name + "</strong>â€¦";

        const fileName = `q-${Date.now()}.pdf`;
        const { error: uploadError } = await supabaseClient.storage.from("assignments").upload(fileName, file);

        if (uploadError) {
            status.className = "";
            status.innerHTML = "âŒ Upload failed: " + uploadError.message;
            return;
        }

        const { data } = supabaseClient.storage.from("assignments").getPublicUrl(fileName);
        await supabaseClient.from("question_papers").upsert([{ id: 1, file_url: data.publicUrl, title: file.name }]);

        status.className = "success";
        status.innerHTML = `
            âœ… <strong>${file.name}</strong> posted to students successfully!
            <a class="view-link" href="${data.publicUrl}" target="_blank">ğŸ‘ View PDF</a>
        `;
    }

    function toggleTheme() { document.body.classList.toggle("light-mode"); }
    function logout() { window.location.href = "index.html"; }

   
    loadAttendance();
    loadDashboard();
    loadClassSummary();
    loadLeaderboard();
</script>

</body>
</html>
